"use strict";(self.webpackChunkbuildflow_docs=self.webpackChunkbuildflow_docs||[]).push([[3320],{3905:(e,t,i)=>{i.d(t,{Zo:()=>u,kt:()=>f});var r=i(7294);function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function p(e,t){if(null==e)return{};var i,r,n=function(e,t){if(null==e)return{};var i,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)i=o[r],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)i=o[r],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}var l=r.createContext({}),s=function(e){var t=r.useContext(l),i=t;return e&&(i="function"==typeof e?e(t):a(a({},t),e)),i},u=function(e){var t=s(e.components);return r.createElement(l.Provider,{value:t},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var i=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,u=p(e,["components","mdxType","originalType","parentName"]),m=s(i),c=n,f=m["".concat(l,".").concat(c)]||m[c]||d[c]||o;return i?r.createElement(f,a(a({ref:t},u),{},{components:i})):r.createElement(f,a({ref:t},u))}));function f(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=i.length,a=new Array(o);a[0]=c;var p={};for(var l in t)hasOwnProperty.call(t,l)&&(p[l]=t[l]);p.originalType=e,p[m]="string"==typeof e?e:n,a[1]=p;for(var s=2;s<o;s++)a[s]=i[s];return r.createElement.apply(null,a)}return r.createElement.apply(null,i)}c.displayName="MDXCreateElement"},5259:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>p,toc:()=>s});var r=i(7462),n=(i(7294),i(3905));const o={},a="Custom Primitives",p={unversionedId:"user-guides/primitives/custom-primitives",id:"user-guides/primitives/custom-primitives",title:"Custom Primitives",description:"Implement the Primitive Interface",source:"@site/docs/user-guides/primitives/custom-primitives.md",sourceDirName:"user-guides/primitives",slug:"/user-guides/primitives/custom-primitives",permalink:"/docs/user-guides/primitives/custom-primitives",draft:!1,editUrl:"https://github.com/launchflow/buildflow-docs/tree/main/docs/user-guides/primitives/custom-primitives.md",tags:[],version:"current",frontMatter:{},sidebar:"mainSidebar",previous:{title:"Portable",permalink:"/docs/user-guides/primitives/portable"},next:{title:"Examples",permalink:"/docs/examples"}},l={},s=[{value:"Implement the Primitive Interface",id:"implement-the-primitive-interface",level:2},{value:"Implement the Provider Interfaces",id:"implement-the-provider-interfaces",level:2},{value:"Source Provider",id:"source-provider",level:3},{value:"Sink Provider",id:"sink-provider",level:3},{value:"Pulumi Provider",id:"pulumi-provider",level:3},{value:"Implement the Strategy Interfaces",id:"implement-the-strategy-interfaces",level:2},{value:"Source Strategy",id:"source-strategy",level:3},{value:"Sink Strategy",id:"sink-strategy",level:3}],u={toc:s},m="wrapper";function d(e){let{components:t,...i}=e;return(0,n.kt)(m,(0,r.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"custom-primitives"},"Custom Primitives"),(0,n.kt)("h2",{id:"implement-the-primitive-interface"},"Implement the Primitive Interface"),(0,n.kt)("p",null,"To create a custom primitivey you can implement the ",(0,n.kt)("a",{parentName:"p",href:"../../reference/api/primitive"},"Primitive")," interface."),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"If your primitive is specific to a cloud provider you can extend ",(0,n.kt)("a",{parentName:"p",href:"../../reference/api/primitive#GCPPrimitive"},"GCPPrimitive")," or ",(0,n.kt)("a",{parentName:"p",href:"../../reference/api/primitive#AWSPrimitive"},"AWSPrimitive"),".")),(0,n.kt)("p",null,"Each primitive may implement any of three methods:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"source_provider()"),": Returns a ",(0,n.kt)("a",{parentName:"li",href:"../../reference/api/provider#source-provider"},"SourceProvider")," for reading data."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"sink_provider()"),": Returns a ",(0,n.kt)("a",{parentName:"li",href:"../../reference/api/provider#sink-provider"},"SinkProvider")," for writing data."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"_pulumi_provider()"),": Returns a ",(0,n.kt)("a",{parentName:"li",href:"../../reference/api/provider#pulumi-provider"},"PulumiProvider")," for the primitive.")),(0,n.kt)("admonition",{type:"note"},(0,n.kt)("p",{parentName:"admonition"},"You are implementing the ",(0,n.kt)("strong",{parentName:"p"},"private")," ",(0,n.kt)("strong",{parentName:"p"},"_pulumi_provider")," method. Not the public version.")),(0,n.kt)("p",null,"Each of these methods should return an instance of the provider class that implements the corresponding interface."),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"You only need to implement the methods that you need. If your primitive only supports reading data you only need to implement the ",(0,n.kt)("inlineCode",{parentName:"p"},"source_provider()")," method, or if your primitive only supports writing data you only need to implement the ",(0,n.kt)("inlineCode",{parentName:"p"},"sink_provider")," method. Similarly if your provider does not support pulumi you do not need to implement the ",(0,n.kt)("inlineCode",{parentName:"p"},"_pulumi_provider")," method.")),(0,n.kt)("p",null,"Example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},"@dataclass\nclass CustomPrimitive(GCPPrimitive):\n    input_field1: str\n    input_field2: str\n\n    def source_provider(self):\n        return CustomPrimitiveProvider(input_field1=self.input_field1, input_field2=self.input_field2)\n\n    def sink_provider(self):\n        return CustomPrimitiveProvider(input_field1=self.input_field1, input_field2=self.input_field2)\n\n    def _pulumi_provider(self):\n        return CustomPrimitiveProvider(input_field1=self.input_field1, input_field2=self.input_field2)\n\n")),(0,n.kt)("h2",{id:"implement-the-provider-interfaces"},"Implement the Provider Interfaces"),(0,n.kt)("p",null,"To define a custom provider you can implement any of the following interfaces:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"../../reference/api/provider#source-provider"},"SourceProvider")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"../../reference/api/provider#sink-provider"},"SinkProvider")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"../../reference/api/provider#pulumi-provider"},"PulumiProvider"))),(0,n.kt)("h3",{id:"source-provider"},"Source Provider"),(0,n.kt)("p",null,"The source provider should implement the ",(0,n.kt)("inlineCode",{parentName:"p"},"source")," method which returns a ",(0,n.kt)("a",{parentName:"p",href:"#source-strategy"},"SourceStrategy")," implementation that defines how to read from a source. If your primitive does not support reading in data (e.g. it is only a sink), feel free to raise a ",(0,n.kt)("inlineCode",{parentName:"p"},"NotImplementedError")," in this method."),(0,n.kt)("p",null,"Example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},"\nclass CustomPrimitiveProvider(SourceProvider, PulumiProvider, SinkProvider):\n    ...\n\n    def source(self, credentials: CredentialType) -> SourceStrategy:\n            return CustomPrimitiveSource(credentials=credentials)\n    ...\n\n")),(0,n.kt)("admonition",{type:"note"},(0,n.kt)("p",{parentName:"admonition"},"The ",(0,n.kt)("inlineCode",{parentName:"p"},"source")," method receives a ",(0,n.kt)("a",{parentName:"p",href:"../../reference/api/credentials"},"credentials object")," that is specific to the cloud (or empty if the primitive is not cloud specific). What credentials a provider is given depends on the ",(0,n.kt)("inlineCode",{parentName:"p"},"PrimitiveType")," determined by your ",(0,n.kt)("inlineCode",{parentName:"p"},"Primitive")," implementation.")),(0,n.kt)("h3",{id:"sink-provider"},"Sink Provider"),(0,n.kt)("p",null,"The sink provider should implement the ",(0,n.kt)("inlineCode",{parentName:"p"},"sink")," method which returns a ",(0,n.kt)("a",{parentName:"p",href:"#sink-strategy"},"SinkStrategy")," implementation that defines how to write data to a sink. If your primitive does not support writing in data (e.g. it is only a source), feel free to raise a ",(0,n.kt)("inlineCode",{parentName:"p"},"NotImplementedError")," in this method."),(0,n.kt)("p",null,"Example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},"\nclass CustomPrimitiveProvider(SourceProvider, PulumiProvider, SinkProvider):\n    ...\n\n    def sink(self, credentials: CredentialType) -> SinkStrategy:\n            return CustomPrimitiveSink(credentials=credentials)\n    ...\n\n")),(0,n.kt)("admonition",{type:"note"},(0,n.kt)("p",{parentName:"admonition"},"The ",(0,n.kt)("inlineCode",{parentName:"p"},"sink")," method receives a ",(0,n.kt)("a",{parentName:"p",href:"../../reference/api/credentials"},"credentials object")," that is specific to the cloud (or empty if the primitive is not cloud specific). What credentials a provider is given depends on the ",(0,n.kt)("inlineCode",{parentName:"p"},"PrimitiveType")," determined by your ",(0,n.kt)("inlineCode",{parentName:"p"},"Primitive")," implementation.")),(0,n.kt)("h3",{id:"pulumi-provider"},"Pulumi Provider"),(0,n.kt)("p",null,"The pulumi provider should implement the ",(0,n.kt)("inlineCode",{parentName:"p"},"pulumi_resource")," method which returns a single ",(0,n.kt)("a",{parentName:"p",href:"https://www.pulumi.com/docs/concepts/resources/components/"},"pulumi.ComponentResource")," that defines what resources to create/manage/destroy in pulumi."),(0,n.kt)("p",null,"The ",(0,n.kt)("inlineCode",{parentName:"p"},"pulumi_resource")," method takes in an optional ",(0,n.kt)("inlineCode",{parentName:"p"},"type_")," argument which is either the output type the pipeline will be sending to the primitive if it is a sink, or it is the input type the pipeline expects to receive from the primitive if it is a source. This can be used to determine the expected schema of any resources that need to be created in pulumi (e.g. the schema of a BigQuery table)."),(0,n.kt)("p",null,"The ",(0,n.kt)("inlineCode",{parentName:"p"},"pulumi_resource")," method also receives a ",(0,n.kt)("a",{parentName:"p",href:"../../reference/api/credentials"},"credentials object")," that is specific to the cloud (or empty if the primitive is not cloud specific). What credentials a provider is given depends on the ",(0,n.kt)("inlineCode",{parentName:"p"},"PrimitiveType")," determined by your ",(0,n.kt)("inlineCode",{parentName:"p"},"Primitive")," implementation."),(0,n.kt)("p",null,"Finally the ",(0,n.kt)("inlineCode",{parentName:"p"},"pulumi_resource")," methods receives a ",(0,n.kt)("inlineCode",{parentName:"p"},"opts")," object of type ",(0,n.kt)("inlineCode",{parentName:"p"},"pulumi.ResourceOptions")," which can should be passed in to your ",(0,n.kt)("inlineCode",{parentName:"p"},"ComponentResource")," super constructor."),(0,n.kt)("p",null,"Example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'\nclass CustomResource(pulumi.ComponentResource):\n\n    def __init__(self, opts: pulumi.ResourceOptions = None):\n        super().__init__(\n            "buildflow:custom_resource:CustomResource",\n            "buildflow-a-unique-id",\n            None,\n            opts,\n        )\n\n        outputs = {}\n\n        self.resource = pulumi.SomeResource(\n            resource_name="a-unuque-name",\n            opts=pulumi.ResourceOptions(parent=self),\n        )\n\n        outputs["custom.resource.id"] = self.resource.id\n        # TIP: This will help the LaunchFlow VSCode extension automatically display useful urls.\n        outputs["buildflow.cloud_console.url"] = "TODO"\n\n        self.register_outputs(outputs)\n\nclass CustomPrimitiveProvider(SourceProvider, PulumiProvider, SinkProvider):\n    ...\n\n    def pulumi_resource(\n        self,\n        type_: Optional[Type],\n        credentials: Union[AWSCredentials, GCPCredentials],\n        opts: pulumi.ResourceOptions,\n    ) -> pulumi.ComponentResource:\n        return CustomResource(opts=opts)\n    ...\n\n')),(0,n.kt)("h2",{id:"implement-the-strategy-interfaces"},"Implement the Strategy Interfaces"),(0,n.kt)("p",null,"Strategies define the actual logic for reading or writing data."),(0,n.kt)("h3",{id:"source-strategy"},"Source Strategy"),(0,n.kt)("p",null,"Source strategies should implement the ",(0,n.kt)("a",{parentName:"p",href:"../../reference/api/strategy#source-strategy"},(0,n.kt)("inlineCode",{parentName:"a"},"SourceStrategy"))," interface."),(0,n.kt)("p",null,"Methods:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"async def pull"),": Pulls data from the source and returns a list of records. Returns a ",(0,n.kt)("inlineCode",{parentName:"li"},"PullResponse")," object containing the payload and information for acknowledging the data from the source. The information for acknowleding will be sent to the ",(0,n.kt)("inlineCode",{parentName:"li"},"ack")," method."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"async def ack"),": Acknowledges that a pull has been successfully processed by the pipeline. The ",(0,n.kt)("inlineCode",{parentName:"li"},"ack")," method receives the ",(0,n.kt)("inlineCode",{parentName:"li"},"ack_info")," object returned by the ",(0,n.kt)("inlineCode",{parentName:"li"},"pull")," method."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"async def backlog"),": Returns the number of records that are currently in the source but have not been pulled yet. This information is used to scale up the number of replicas pulling from the source."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"def max_batch_size"),": The maximum number of elements that can be returned by a call to pull."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"def pull_converter"),": Returns a function that can be used to convert the payload returned by the ",(0,n.kt)("inlineCode",{parentName:"li"},"pull")," method into the data the user expects. For example this may return a function that converts the payload into dataclass.")),(0,n.kt)("p",null,"Example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},"\nclass CustomAckInfo(AckInfo):\n    pass\n\nclass CustomPrimitiveSource(SourceStrategy):\n\n    async def pull(self) -> PullResponse:\n        return PullResponse(\n            payload=[1, 2, 3],\n            ack_info=CustomAckInfo(),\n        )\n\n    async def ack(self, to_ack: AckInfo, success: bool):\n        return\n\n    async def backlog(self) -> int:\n        return 0\n\n    def max_batch_size(self) -> int:\n        return -1\n\n    def pull_converter(self, user_defined_type: Type) -> Callable[[Any], Any]:\n        return converters.identify()\n\n")),(0,n.kt)("h3",{id:"sink-strategy"},"Sink Strategy"),(0,n.kt)("p",null,"Sink strategies should implement the ",(0,n.kt)("a",{parentName:"p",href:"../../reference/api/strategy#sink-strategy"},(0,n.kt)("inlineCode",{parentName:"a"},"SinkStrategy"))," interface."),(0,n.kt)("p",null,"Methods:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"async def push"),": Pushes data to the sink."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"def push_converter"),": Returns a function that can be used to convert the payload returned by the users pipeline into the data type that is expected by the sink.")),(0,n.kt)("p",null,"Example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},'\nclass CustomPrimitiveSink(SinkStrategy):\n    async def push(self, batch: Batch):\n        print("pushing data: ", batch)\n\n    def push_converter(self, user_defined_type: Type) -> Callable[[Any], Any]:\n        return converters.identify()\n\n')),(0,n.kt)("h1",{id:"using-your-custom-primitive"},"Using Your Custom Primitive"),(0,n.kt)("p",null,"Once complete you can plug your custom primitive directly into the ",(0,n.kt)("inlineCode",{parentName:"p"},"app.pipeline")," decorator."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-python"},"@app.pipeline(source=CustomPrimitive(), sink=CustomPrimitive())\ndef my_pipeline():\n    ...\n")))}d.isMDXComponent=!0}}]);